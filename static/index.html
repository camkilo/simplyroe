<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Realm of Echoes - Infinite</title>
<style>
body {background:#111;color:#eee;font-family:sans-serif;margin:0;padding:0;}
#game {display:grid; grid-gap:2px; margin:10px auto;}
.tile {width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:#222;border:1px solid #333;cursor:pointer;transition:0.2s;}
.tile.player {border:2px solid cyan;animation:pulse 1s infinite;}
.tile.glow {box-shadow:0 0 15px gold;}
@keyframes pulse {0%{box-shadow:0 0 5px cyan;}50%{box-shadow:0 0 15px cyan;}100%{box-shadow:0 0 5px cyan;}}
#log {max-height:150px;overflow:auto;margin-top:10px;}
button{margin:5px;padding:5px 10px;cursor:pointer;}
</style>
</head>
<body>
<h2 style="text-align:center;">Realm of Echoes</h2>
<div id="game"></div>
<div style="text-align:center;">
    <button onclick="gather()">Gather</button>
    <button onclick="craft()">Craft</button>
    <div id="log"></div>
</div>

<script>
const CHUNK_SIZE=10;
let chunk_x=0, chunk_y=0;
let player={x:0,y:0,inventory:[],id:"player1"};
let world_chunk={};

function logMessage(msg){
    const log=document.getElementById('log');
    const p=document.createElement('p');
    p.textContent=msg;
    log.prepend(p);
}

async function loadChunk(cx,cy){
    const res=await fetch(`/get_chunk?cx=${cx}&cy=${cy}`);
    world_chunk = await res.json();
    drawWorld();
}

function drawWorld(){
    const game = document.getElementById('game');
    game.style.gridTemplateColumns = `repeat(${CHUNK_SIZE},40px)`;
    game.innerHTML = '';
    for(let y=0;y<CHUNK_SIZE;y++){
        for(let x=0;x<CHUNK_SIZE;x++){
            const key=`${x},${y}`;
            const tile=document.createElement('div');
            tile.className='tile '+world_chunk[key].biome;
            if(world_chunk[key].effect) tile.classList.add(world_chunk[key].effect);
            if(player.x===x && player.y===y) tile.classList.add('player');
            tile.onclick=()=>movePlayer(x,y);
            game.appendChild(tile);
        }
    }
}

function movePlayer(x,y){
    player.x=x; player.y=y;
    // auto-load next chunk if at edge
    if(x===CHUNK_SIZE-1){chunk_x++;player.x=0;loadChunk(chunk_x,chunk_y);}
    if(x===0 && chunk_x>0){chunk_x--;player.x=CHUNK_SIZE-1;loadChunk(chunk_x,chunk_y);}
    if(y===CHUNK_SIZE-1){chunk_y++;player.y=0;loadChunk(chunk_x,chunk_y);}
    if(y===0 && chunk_y>0){chunk_y--;player.y=CHUNK_SIZE-1;loadChunk(chunk_x,chunk_y);}
    drawWorld();
    logMessage(`Moved to ${world_chunk[`${x},${y}`].biome} biome`);
}

async function gather(){
    const res = await fetch(`/gather?player_id=${player.id}&cx=${chunk_x}&cy=${chunk_y}&x=${player.x}&y=${player.y}`);
    const data = await res.json();
    player.inventory.push(data.item);
    if(data.effect) world_chunk[`${player.x},${player.y}`].effect = data.effect;
    drawWorld();
    logMessage(`Gathered: ${data.item} (${data.rarity})`);
}

async function craft(){
    const res = await fetch(`/craft?player_id=${player.id}`);
    const data = await res.json();
    if(data.item) logMessage(`Crafted: ${data.item} (${data.rarity})`);
    if(data.new_tiles) data.new_tiles.forEach(t=>{
        world_chunk[`${t.x},${t.y}`] = {biome:t.biome,effect:t.effect};
    });
    player.inventory = [];
    drawWorld();
}

loadChunk(chunk_x,chunk_y);
</script>
</body>
</html>
